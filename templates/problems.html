{% extends "base.html" %}

{% block title %}Problemliste{% endblock %}

{% block content %}
<style>
.bg-light {
    background-color: #f8f9fa !important;
}
.badge {
    font-weight: 500;
    font-size: 0.875rem;
}
.btn {
    border-radius: 8px;
}
</style>
    <div class="container py-5">
        <!-- Dezente Filter-Leiste -->
        <div class="card shadow-sm mb-4 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="card-title text-dark mb-0 d-flex align-items-center">
                        <i class="bi bi-funnel me-2 text-muted"></i>Filter
                    </h5>
                    <a href="{{ url_for('problems') }}" class="btn btn-outline-secondary btn-sm px-3">
                        <i class="bi bi-arrow-clockwise me-1"></i>Zur√ºcksetzen
                    </a>
                </div>
                
                <!-- Filter-Grid mit Cards -->
                <div class="row g-3">
                    <!-- Anlagen-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-gear text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Anlage</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems') }}" 
                                   class="btn btn-sm {% if not request.args.get('bohrturm') %}btn-primary{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm='T-700', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-700' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-700</a>
                                <a href="{{ url_for('problems', bohrturm='T-46', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-46' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-46</a>
                                <a href="{{ url_for('problems', bohrturm='T-208', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-208' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-208</a>
                                <a href="{{ url_for('problems', bohrturm='T-207', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-207' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-207</a>
                            </div>
                        </div>
                    </div>

                    <!-- Abteilungs-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-people text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Abteilung</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status')) }}" 
                                   class="btn btn-sm {% if not request.args.get('abteilung') %}btn-success{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Elektrisch') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Elektrisch' %}btn-success{% else %}btn-outline-secondary{% endif %}">Elektrisch</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Mechanisch') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Mechanisch' %}btn-success{% else %}btn-outline-secondary{% endif %}">Mechanisch</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Anlage') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Anlage' %}btn-success{% else %}btn-outline-secondary{% endif %}">Anlage</a>
                            </div>
                        </div>
                    </div>

                    <!-- Status-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-flag text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Status</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if not request.args.get('status') %}btn-dark{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='gemeldet') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'gemeldet' %}btn-danger{% else %}btn-outline-secondary{% endif %}">Gemeldet</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='in_bearbeitung') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'in_bearbeitung' %}btn-primary{% else %}btn-outline-secondary{% endif %}">In Bearbeitung</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='abgearbeitet') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'abgearbeitet' %}btn-success{% else %}btn-outline-secondary{% endif %}">Abgearbeitet</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aktive Filter Anzeige -->
                {% set active_filters = [] %}
                {% if request.args.get('bohrturm') %}{% set _ = active_filters.append('Anlage: ' + request.args.get('bohrturm')) %}{% endif %}
                {% if request.args.get('abteilung') %}{% set _ = active_filters.append('Abteilung: ' + request.args.get('abteilung')) %}{% endif %}
                {% if request.args.get('status') %}{% set _ = active_filters.append('Status: ' + request.args.get('status')) %}{% endif %}
                
                {% if active_filters %}
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex align-items-center text-muted">
                        <i class="bi bi-funnel-fill me-2"></i>
                        <small class="me-2">Aktive Filter:</small>
                        {% for filter in active_filters %}
                            <span class="badge bg-secondary me-1">{{ filter }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="card-title mb-0">Alle gemeldeten Probleme</h1>
                    <div class="d-flex align-items-center gap-3">
                        <!-- Manueller Refresh -->
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshProblemsTable()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Jetzt aktualisieren
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Anlage</th>
                                <th>Abteilung</th>
                                <th>System</th>
                                <th>Problem</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for p in problems %}
                        <tr class="{% if p.status == 'gemeldet' %}table-danger
                                   {% elif p.status == 'in_bearbeitung' %}table-primary
                                   {% elif p.status == 'abgearbeitet' %}table-success
                                   {% endif %}">
                            <td>{{ p.id }}</td>
                            <td>{{ p.bohrturm }}</td>
                            <td>
                                <span class="badge {% if p.abteilung == 'Elektrisch' %}bg-primary
                                                   {% elif p.abteilung == 'Mechanisch' %}bg-secondary  
                                                   {% elif p.abteilung == 'Anlage' %}bg-success
                                                   {% endif %}">{{ p.abteilung }}</span>
                            </td>
                            <td>{{ p.system }}</td>
                            <td>
                                <div>{{ p.problem }}</div>
                                {% if p.image_list %}
                                <div class="mt-2">
                                    <i class="bi bi-camera text-muted me-1"></i>
                                    <small class="text-muted">{{ p.image_list|length }} Bild(er) verf√ºgbar</small>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                            data-bs-toggle="modal" data-bs-target="#imageModal{{ p.id }}">
                                        <i class="bi bi-eye"></i> Anzeigen
                                    </button>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if p.status == 'gemeldet' %}
                                        <span class="badge bg-danger">Gemeldet</span>
                                        {% if p.assigned_user %}
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-fill me-1"></i>Zugewiesen an: 
                                                    <strong class="text-primary">{{ p.assigned_user.username }}</strong>
                                                </small>
                                            </div>
                                        {% elif p.verantwortlicher %}
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-fill me-1"></i>Zugewiesen an: 
                                                    <strong class="text-primary">{{ p.verantwortlicher }}</strong>
                                                </small>
                                            </div>
                                        {% endif %}
                                    {% elif p.status == 'in_bearbeitung' %}
                                        <span class="badge bg-primary">In Bearbeitung</span>
                                        {% if p.assigned_user %}
                                            <div class="mt-1">
                                                <small class="text-success">
                                                    <i class="bi bi-person-check-fill me-1"></i>Bearbeiter: 
                                                    <strong>{{ p.assigned_user.username }}</strong>
                                                </small>
                                            </div>
                                        {% elif p.verantwortlicher %}
                                            <div class="mt-1">
                                                <small class="text-success">
                                                    <i class="bi bi-person-check-fill me-1"></i>Bearbeiter: 
                                                    <strong>{{ p.verantwortlicher }}</strong>
                                                </small>
                                            </div>
                                            {% if p.massnahmen %}
                                                <p class="small text-muted mt-1">Ma√ünahmen: {{ p.massnahmen }}</p>
                                            {% endif %}
                                            {% if p.bestellung_benoetigt %}
                                                <div class="mt-1">
                                                    {% if p.bestellung_bestaetigt %}
                                                    <span class="badge bg-success me-1">
                                                        <i class="bi bi-check-circle me-1"></i>Material best√§tigt
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning me-1">
                                                        <i class="bi bi-clock me-1"></i>Material ausstehend
                                                    </span>
                                                {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% elif p.status == 'abgearbeitet' %}
                                        <span class="badge bg-success">Abgearbeitet - Pr√ºfung steht aus</span>
                                    {% endif %}
                                </div>
                                {% if p.loeschen_kommentar %}
                                    <p class="small text-muted mt-1">Kommentar: {{ p.loeschen_kommentar }}</p>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    {% if p.status == 'gemeldet' %}
                                        <button type="button" class="btn btn-info btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-pencil me-1"></i>In Bearbeitung nehmen
                                        </button>
                                        {% if is_admin %}
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% elif p.status == 'in_bearbeitung' %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-pencil me-1"></i>Bearbeiten
                                        </button>
                                        {% if is_admin %}
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% elif p.status == 'abgearbeitet' %}
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-info-circle me-1"></i>Details ansehen
                                        </button>
                                        {% if is_admin %}
                                        <a href="{{ url_for('delete_problem', problem_id=p.id) }}" 
                                           class="btn btn-primary btn-sm">Pr√ºfen & L√∂schen</a>
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('problem') }}" class="btn btn-primary">Neues Problem melden</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bild-Modals f√ºr jedes Problem -->
    {% for p in problems %}
        {% if p.image_list %}
        <div class="modal fade" id="imageModal{{ p.id }}" tabindex="-1" aria-labelledby="imageModalLabel{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel{{ p.id }}">
                            <i class="bi bi-images me-2"></i>Bilder zu Problem #{{ p.id }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            {% for image in p.image_list %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                                         class="card-img-top" alt="Problem Bild" style="height: 200px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="text-muted">{{ image }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}

    <!-- Detail-Modals f√ºr jedes Problem -->
    {% for p in problems %}
    <div class="modal fade" id="detailModal{{ p.id }}" tabindex="-1" aria-labelledby="detailModalLabel{{ p.id }}" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 3px solid #0d6efd;">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="bi bi-info-circle-fill text-primary fs-5"></i>
                        </div>
                        <div>
                            <h5 class="modal-title mb-0 fw-bold text-dark" id="detailModalLabel{{ p.id }}">
                                Problem Details #{{ p.id }}
                            </h5>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>Erstellt: {{ p.created_at.strftime('%d.%m.%Y %H:%M') if p.created_at else 'Unbekannt' }}
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="problemTabs{{ p.id }}" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="details-tab{{ p.id }}" data-bs-toggle="tab" 
                                    data-bs-target="#details{{ p.id }}" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i>Details
                            </button>
                        </li>
                        <!-- Material Tab - nur bei entsprechendem Status -->
                        {% if (p.status == 'in_bearbeitung' and p.massnahmen) or p.status == 'abgearbeitet' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="material-tab{{ p.id }}" data-bs-toggle="tab" 
                                    data-bs-target="#material{{ p.id }}" type="button" role="tab">
                                <i class="bi bi-box-seam me-1"></i>Material
                                {% if p.bestellung_benoetigt %}
                                <span class="badge bg-warning ms-1">!</span>
                                {% endif %}
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="problemTabContent{{ p.id }}">
                        <!-- Details Tab -->
                        <div class="tab-pane fade show active" id="details{{ p.id }}" role="tabpanel">
                            <!-- Problembeschreibung -->
                            <div class="mb-3">
                                <h6 class="text-primary mb-2">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Problembeschreibung
                                </h6>
                                <p class="mb-0">{{ p.problem }}</p>
                            </div>
                            
                            <!-- Kompakte Info-Zeile -->
                            <div class="d-flex align-items-center gap-4 bg-light rounded p-3 mb-3">
                                <!-- Status -->
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">STATUS:</small>
                                    {% if p.status == 'gemeldet' %}
                                        <span class="badge bg-danger">GEMELDET</span>
                                    {% elif p.status == 'in_bearbeitung' %}
                                        <span class="badge bg-primary">IN BEARBEITUNG</span>
                                    {% elif p.status == 'abgearbeitet' %}
                                        <span class="badge bg-success">ABGEARBEITET</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Bearbeiter -->
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">BEARBEITER:</small>
                                    {% if p.assigned_user %}
                                        <span class="fw-bold">{{ p.assigned_user.username }}</span>
                                    {% elif p.verantwortlicher %}
                                        <span class="fw-bold">{{ p.verantwortlicher }}</span>
                                    {% else %}
                                        <span class="text-muted">Nicht zugewiesen</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Anlage -->
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">ANLAGE:</small>
                                    <span class="fw-bold">{{ p.bohrturm }}</span>
                                </div>
                            </div>
                            
                            <!-- Ma√ünahmen - nur wenn vorhanden -->
                            {% if p.massnahmen %}
                            <div class="bg-primary bg-opacity-10 rounded p-3 mb-3">
                                <small class="text-primary fw-semibold d-block mb-1">GEPLANTE MASSNAHMEN</small>
                                <p class="mb-0">{{ p.massnahmen }}</p>
                            </div>
                            {% endif %}

                            <!-- Workflow-Buttons -->
                            {% if p.status == 'gemeldet' %}
                                {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                <div class="text-center mt-4">
                                    <a href="{{ url_for('edit_problem', problem_id=p.id) }}" 
                                       class="btn btn-primary btn-lg">
                                        <i class="bi bi-arrow-right me-2"></i>In Bearbeitung nehmen
                                    </a>
                                </div>
                                {% endif %}
                            {% elif p.status == 'abgearbeitet' %}
                            <div class="text-center mt-4">
                                <a href="{{ url_for('delete_problem', problem_id=p.id) }}" 
                                   class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle me-2"></i>Abschlie√üen
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Material Tab -->
                        {% if (p.status == 'in_bearbeitung' and p.massnahmen) or p.status == 'abgearbeitet' %}
                        <div class="tab-pane fade" id="material{{ p.id }}" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-12">
                                    <!-- Material hinzuf√ºgen Button -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="bi bi-box-seam me-2"></i>Material-Liste
                                        </h6>
                                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="collapse" data-bs-target="#addMaterial{{ p.id }}">
                                            <i class="bi bi-plus-circle me-1"></i>Material hinzuf√ºgen
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Material hinzuf√ºgen Form (collapsed) -->
                                    <div class="collapse mb-3" id="addMaterial{{ p.id }}">
                                        <div class="card border-light bg-light">
                                            <div class="card-body">
                                                <form method="post" action="{{ url_for('add_material', problem_id=p.id) }}">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label for="mm_nummer{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-upc-scan me-1"></i>MM-Nummer *
                                                            </label>
                                                            <input type="text" id="mm_nummer{{ p.id }}" name="mm_nummer" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. MM-234234" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="beschreibung{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-tag me-1"></i>Beschreibung *
                                                            </label>
                                                            <input type="text" id="beschreibung{{ p.id }}" name="beschreibung" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. Hydraulikzylinder" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="menge{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-123 me-1"></i>Menge
                                                            </label>
                                                            <input type="number" id="menge{{ p.id }}" name="menge" 
                                                                   class="form-control form-control-sm" 
                                                                   value="1" min="1">
                                                        </div>
                                                        <div class="col-md-3 d-flex align-items-end">
                                                            <button type="submit" class="btn btn-success btn-sm w-100">
                                                                <i class="bi bi-plus me-1"></i>Hinzuf√ºgen
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Material-Liste -->
                                    {% if p.materials %}
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col"><i class="bi bi-upc-scan me-1"></i>MM-Nummer</th>
                                                    <th scope="col"><i class="bi bi-tag me-1"></i>Beschreibung</th>
                                                    <th scope="col"><i class="bi bi-123 me-1"></i>Menge</th>
                                                    <!-- RSC Material-Order-Management Spalten -->
                                                    {% if is_rsc_for_problem(p) %}
                                                    <th scope="col"><i class="bi bi-receipt me-1"></i>PR-Nummer</th>
                                                    <th scope="col"><i class="bi bi-basket me-1"></i>PO-Nummer</th>
                                                    <th scope="col"><i class="bi bi-calendar me-1"></i>Lieferdatum</th>
                                                    <th scope="col"><i class="bi bi-check-circle me-1"></i>Best√§tigt</th>
                                                    {% endif %}
                                                    <th scope="col">Aktionen</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for material in p.materials %}
                                                <tr>
                                                    <td><code>{{ material.mm_nummer }}</code></td>
                                                    <td>{{ material.beschreibung }}</td>
                                                    <td><span class="badge bg-secondary">{{ material.menge or 1 }}x</span></td>
                                                    
                                                    <!-- RSC Material-Order-Management Felder -->
                                                    {% if is_rsc_for_problem(p) %}
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   value="{{ material.pr_nummer or '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'pr_nummer', this.value)"
                                                                   placeholder="PR-Nummer">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-basket"></i></span>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   value="{{ material.po_nummer or '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'po_nummer', this.value)"
                                                                   placeholder="PO-Nummer">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                            <input type="date" class="form-control form-control-sm" 
                                                                   value="{{ material.lieferdatum.strftime('%Y-%m-%d') if material.lieferdatum else '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'lieferdatum', this.value)">
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        {% if material.bestellung_bestaetigt %}
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle me-1"></i>Best√§tigt
                                                            </span>
                                                        {% else %}
                                                            <button class="btn btn-outline-success btn-sm" 
                                                                    onclick="confirmMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                                <i class="bi bi-check"></i>
                                                            </button>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    
                                                    <td>
                                                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                                        <button class="btn btn-outline-danger btn-sm" 
                                                                onclick="deleteMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-box-seam fs-1 opacity-25"></i>
                                        <p class="mt-2">Noch kein Material hinzugef√ºgt</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Progress Updates - au√üerhalb der Tabs -->
                    {% if p.progress_update_list %}
                    <div class="mt-3 border-top pt-3">
                        <h6 class="fw-semibold mb-2">
                            <i class="bi bi-clock-history me-1 text-success"></i>Fortschritt-Updates:
                        </h6>
                        {% for update in p.progress_update_list %}
                        <div class="alert alert-success py-2 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <small class="d-block">{{ update.text }}</small>
                                </div>
                            </div>
                            <hr class="my-1">
                            <small class="text-muted">
                                <i class="bi bi-person me-1"></i>{{ update.user }} ‚Ä¢ 
                                <i class="bi bi-clock me-1"></i>{{ update.timestamp[:19] | replace('T', ' ') }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Ma√ünahme hinzuf√ºgen - nur bei in Bearbeitung und Berechtigung -->
                    {% if p.status == 'in_bearbeitung' and (is_admin or (user_facility and user_facility == p.bohrturm)) %}
                    <div class="mt-3 border-top pt-3">
                        <button type="button" class="btn btn-outline-success btn-sm w-100" 
                                data-bs-toggle="collapse" data-bs-target="#addUpdate{{ p.id }}" 
                                aria-expanded="false">
                            <i class="bi bi-plus-circle me-1"></i>Ma√ünahme hinzuf√ºgen
                        </button>
                        
                        <div class="collapse mt-2" id="addUpdate{{ p.id }}">
                            <form method="post" action="{{ url_for('add_progress_update', problem_id=p.id) }}">
                                <div class="card border-success">
                                    <div class="card-body p-3">
                                        <div class="mb-2">
                                            <label for="updateText{{ p.id }}" class="form-label fw-semibold small">
                                                <i class="bi bi-pencil me-1"></i>Fortschritt-Update:
                                            </label>
                                            <textarea id="updateText{{ p.id }}" name="update_text" 
                                                      class="form-control form-control-sm" rows="2" 
                                                      placeholder="z.B. Teil eingelagert - Warte auf Zugriff an Maschine" 
                                                      required></textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-check2 me-1"></i>Hinzuf√ºgen
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    data-bs-toggle="collapse" data-bs-target="#addUpdate{{ p.id }}">
                                                Abbrechen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- L√∂schkommentar anzeigen -->
                    {% if p.loeschen_kommentar %}
                    <div class="mt-3 border-top pt-3">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">
                                <i class="bi bi-chat-text me-2"></i>Kommentar
                            </h6>
                            <p class="mb-0">{{ p.loeschen_kommentar }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer border-top d-flex justify-content-between">
                    <!-- Fertiggestellt Button -->
                    {% if not p.behoben %}
                    <form method="post" action="{{ url_for('mark_problem_resolved', problem_id=p.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-success" onclick="return confirm('Problem als fertiggestellt markieren?')">
                            <i class="bi bi-check-circle me-1"></i>Fertiggestellt
                        </button>
                    </form>
                    {% else %}
                    <span class="badge bg-success fs-6">
                        <i class="bi bi-check-circle me-1"></i>Bereits Fertiggestellt
                    </span>
                    {% endif %}
                    
                    <!-- Schlie√üen Button -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Schlie√üen
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Verstecktes Form f√ºr direktes L√∂schen -->
    {% if is_admin %}
    <form id="deleteForm" method="post" style="display: none;">
        <input type="hidden" name="direct_delete" value="1">
        <input type="hidden" name="problem_id" id="deleteProblemId">
    </form>
    {% endif %}

    <script>
        {% if is_admin %}
        function confirmDelete(problemId, problemText) {
            if (confirm('‚ö†Ô∏è ACHTUNG: Problem direkt l√∂schen?\n\n"' + problemText + '"\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                document.getElementById('deleteProblemId').value = problemId;
                document.getElementById('deleteForm').action = '/admin/delete_problem/' + problemId;
                document.getElementById('deleteForm').submit();
            }
        }
        {% endif %}

        // Material-Management Funktionen
        function updateMaterialField(materialId, fieldName, value) {
            fetch(`/update_material_field/${materialId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(`Fehler beim Aktualisieren: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Aktualisieren der Daten');
            });
        }

        function confirmMaterial(materialId, materialName) {
            if (confirm(`Material-Bestellung "${materialName}" best√§tigen?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/confirm_material/${materialId}`;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        function deleteMaterial(materialId, materialName) {
            if (confirm(`Material "${materialName}" wirklich l√∂schen?`)) {
                fetch(`/delete_material/${materialId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const button = document.querySelector(`button[onclick*="deleteMaterial(${materialId}"]`);
                        if (button) {
                            const row = button.closest('tr');
                            if (row) {
                                row.remove();
                            }
                        }
                    } else {
                        alert('Fehler beim L√∂schen: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    alert('Fehler beim L√∂schen');
                });
            }
        }

        // Auto-Refresh Funktion
        function refreshProblemsTable() {
            fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const newTableContainer = doc.querySelector('.table-responsive');
                const currentTableContainer = document.querySelector('.table-responsive');
                
                if (newTableContainer && currentTableContainer) {
                    currentTableContainer.innerHTML = newTableContainer.innerHTML;
                    
                    const newModals = doc.querySelectorAll('.modal');
                    const currentModals = document.querySelectorAll('.modal');
                    
                    // Entferne alte Modals
                    currentModals.forEach(modal => {
                        if (modal.id.startsWith('detailModal') || modal.id.startsWith('imageModal')) {
                            modal.remove();
                        }
                    });
                    
                    // F√ºge neue Modals hinzu
                    newModals.forEach(modal => {
                        if (modal.id.startsWith('detailModal') || modal.id.startsWith('imageModal')) {
                            document.body.appendChild(modal);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Fehler beim Aktualisieren der Tabelle:', error);
            });
        }

        // Auto-Refresh alle 60 Sekunden
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(refreshProblemsTable, 60000);
        });
    </script>
{% endblock %}