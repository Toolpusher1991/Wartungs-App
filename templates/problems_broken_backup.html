{% extends "base.html" %}

{% block title %}Problemliste{% endblock %}

{% block content %}
<style>
.bg-light {
    background-color: #f8f9fa !important;
}
.badge {
    font-weight: 500;
    font-size: 0.875rem;
}
.btn {
    border-radius: 8px;
}
</style>
    <div class="container py-5">
        <!-- Dezente Filter-Leiste -->
        <div class="card shadow-sm mb-4 border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="card-title text-dark mb-0 d-flex align-items-center">
                        <i class="bi bi-funnel me-2 text-muted"></i>Filter
                    </h5>
                    <a href="{{ url_for('problems') }}" class="btn btn-outline-secondary btn-sm px-3">
                        <i class="bi bi-arrow-clockwise me-1"></i>Zurücksetzen
                    </a>
                </div>
                
                <!-- Filter-Grid mit Cards -->
                <div class="row g-3">
                    <!-- Anlagen-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-gear text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Anlage</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems') }}" 
                                   class="btn btn-sm {% if not request.args.get('bohrturm') %}btn-primary{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm='T-700', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-700' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-700</a>
                                <a href="{{ url_for('problems', bohrturm='T-46', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-46' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-46</a>
                                <a href="{{ url_for('problems', bohrturm='T-208', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-208' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-208</a>
                                <a href="{{ url_for('problems', bohrturm='T-207', status=request.args.get('status'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if request.args.get('bohrturm') == 'T-207' %}btn-primary{% else %}btn-outline-secondary{% endif %}">T-207</a>
                            </div>
                        </div>
                    </div>

                    <!-- Abteilungs-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-people text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Abteilung</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status')) }}" 
                                   class="btn btn-sm {% if not request.args.get('abteilung') %}btn-success{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Elektrisch') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Elektrisch' %}btn-success{% else %}btn-outline-secondary{% endif %}">Elektrisch</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Mechanisch') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Mechanisch' %}btn-success{% else %}btn-outline-secondary{% endif %}">Mechanisch</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), status=request.args.get('status'), abteilung='Anlage') }}" 
                                   class="btn btn-sm {% if request.args.get('abteilung') == 'Anlage' %}btn-success{% else %}btn-outline-secondary{% endif %}">Anlage</a>
                            </div>
                        </div>
                    </div>

                    <!-- Status-Filter -->
                    <div class="col-lg-4">
                        <div class="filter-group bg-white rounded p-3 border">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-flag text-muted me-2"></i>
                                <h6 class="mb-0 fw-semibold text-dark">Status</h6>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung')) }}" 
                                   class="btn btn-sm {% if not request.args.get('status') %}btn-dark{% else %}btn-outline-secondary{% endif %}">Alle</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='gemeldet') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'gemeldet' %}btn-danger{% else %}btn-outline-secondary{% endif %}">Gemeldet</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='in_bearbeitung') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'in_bearbeitung' %}btn-primary{% else %}btn-outline-secondary{% endif %}">In Bearbeitung</a>
                                <a href="{{ url_for('problems', bohrturm=request.args.get('bohrturm'), abteilung=request.args.get('abteilung'), status='abgearbeitet') }}" 
                                   class="btn btn-sm {% if request.args.get('status') == 'abgearbeitet' %}btn-success{% else %}btn-outline-secondary{% endif %}">Abgearbeitet</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aktive Filter Anzeige -->
                {% set active_filters = [] %}
                {% if request.args.get('bohrturm') %}{% set _ = active_filters.append('Anlage: ' + request.args.get('bohrturm')) %}{% endif %}
                {% if request.args.get('abteilung') %}{% set _ = active_filters.append('Abteilung: ' + request.args.get('abteilung')) %}{% endif %}
                {% if request.args.get('status') %}{% set _ = active_filters.append('Status: ' + request.args.get('status')) %}{% endif %}
                
                {% if active_filters %}
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex align-items-center text-muted">
                        <i class="bi bi-funnel-fill me-2"></i>
                        <small class="me-2">Aktive Filter:</small>
                        {% for filter in active_filters %}
                            <span class="badge bg-secondary me-1">{{ filter }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="card-title mb-0">Alle gemeldeten Probleme</h1>
                    <div class="d-flex align-items-center gap-3">
                        <!-- Manueller Refresh -->
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshProblemsTable()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Jetzt aktualisieren
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Anlage</th>
                                <th>Abteilung</th>
                                <th>System</th>
                                <th>Problem</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for p in problems %}
                        <tr class="{% if p.status == 'gemeldet' %}table-danger
                                   {% elif p.status == 'in_bearbeitung' %}table-primary
                                   {% elif p.status == 'abgearbeitet' %}table-success
                                   {% endif %}">
                            <td>{{ p.id }}</td>
                            <td>{{ p.bohrturm }}</td>
                            <td>
                                <span class="badge {% if p.abteilung == 'Elektrisch' %}bg-primary
                                                   {% elif p.abteilung == 'Mechanisch' %}bg-secondary  
                                                   {% elif p.abteilung == 'Anlage' %}bg-success
                                                   {% endif %}">{{ p.abteilung }}</span>
                            </td>
                            <td>{{ p.system }}</td>
                            <td>
                                <div>{{ p.problem }}</div>
                                {% if p.image_list %}
                                <div class="mt-2">
                                    <i class="bi bi-camera text-muted me-1"></i>
                                    <small class="text-muted">{{ p.image_list|length }} Bild(er) verfügbar</small>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                            data-bs-toggle="modal" data-bs-target="#imageModal{{ p.id }}">
                                        <i class="bi bi-eye"></i> Anzeigen
                                    </button>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if p.status == 'gemeldet' %}
                                        <span class="badge bg-danger">Gemeldet</span>
                                        {% if p.assigned_user %}
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-fill me-1"></i>Zugewiesen an: 
                                                    <strong class="text-primary">{{ p.assigned_user.username }}</strong>
                                                </small>
                                            </div>
                                        {% elif p.verantwortlicher %}
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-fill me-1"></i>Zugewiesen an: 
                                                    <strong class="text-primary">{{ p.verantwortlicher }}</strong>
                                                </small>
                                            </div>
                                        {% endif %}
                                    {% elif p.status == 'in_bearbeitung' %}
                                        <span class="badge bg-primary">In Bearbeitung</span>
                                        {% if p.assigned_user %}
                                            <div class="mt-1">
                                                <small class="text-success">
                                                    <i class="bi bi-person-check-fill me-1"></i>Bearbeiter: 
                                                    <strong>{{ p.assigned_user.username }}</strong>
                                                </small>
                                            </div>
                                        {% elif p.verantwortlicher %}
                                            <div class="mt-1">
                                                <small class="text-success">
                                                    <i class="bi bi-person-check-fill me-1"></i>Bearbeiter: 
                                                    <strong>{{ p.verantwortlicher }}</strong>
                                                </small>
                                            </div>
                                            {% if p.massnahmen %}
                                                <p class="small text-muted mt-1">Maßnahmen: {{ p.massnahmen }}</p>
                                            {% endif %}
                                            {% if p.bestellung_benoetigt %}
                                                <div class="mt-1">
                                                    {% if p.bestellung_bestaetigt %}
                                                    <span class="badge bg-success me-1">
                                                        <i class="bi bi-check-circle me-1"></i>Material bestätigt
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning me-1">
                                                        <i class="bi bi-clock me-1"></i>Material ausstehend
                                                    </span>
                                                {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% elif p.status == 'abgearbeitet' %}
                                        <span class="badge bg-success">Abgearbeitet - Prüfung steht aus</span>
                                    {% endif %}
                                </div>
                                {% if p.loeschen_kommentar %}
                                    <p class="small text-muted mt-1">Kommentar: {{ p.loeschen_kommentar }}</p>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    {% if p.status == 'gemeldet' %}
                                        <button type="button" class="btn btn-info btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-pencil me-1"></i>In Bearbeitung nehmen
                                        </button>
                                        {% if is_admin %}
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% elif p.status == 'in_bearbeitung' %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-pencil me-1"></i>Bearbeiten
                                        </button>
                                        {% if is_admin %}
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% elif p.status == 'abgearbeitet' %}
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                data-bs-toggle="modal" data-bs-target="#detailModal{{ p.id }}">
                                            <i class="bi bi-info-circle me-1"></i>Details ansehen
                                        </button>
                                        {% if is_admin %}
                                        <a href="{{ url_for('delete_problem', problem_id=p.id) }}" 
                                           class="btn btn-primary btn-sm">Prüfen & Löschen</a>
                                        <button type="button" class="btn btn-danger btn-sm" 
                                                onclick="confirmDelete({{ p.id }}, '{{ p.problem[:50] }}{% if p.problem|length > 50 %}...{% endif %}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('problem') }}" class="btn btn-primary">Neues Problem melden</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bild-Modals für jedes Problem -->
    {% for p in problems %}
        {% if p.image_list %}
        <div class="modal fade" id="imageModal{{ p.id }}" tabindex="-1" aria-labelledby="imageModalLabel{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel{{ p.id }}">
                            <i class="bi bi-images me-2"></i>Bilder zu Problem #{{ p.id }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            {% for image in p.image_list %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                                         class="card-img-top" alt="Problem Bild" style="height: 200px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="text-muted">{{ image }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}

    <!-- Detail-Modals für jedes Problem -->
    {% for p in problems %}
    <div class="modal fade" id="detailModal{{ p.id }}" tabindex="-1" aria-labelledby="detailModalLabel{{ p.id }}" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 3px solid #0d6efd;">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="bi bi-info-circle-fill text-primary fs-5"></i>
                        </div>
                        <div>
                            <h5 class="modal-title mb-0 fw-bold text-dark" id="detailModalLabel{{ p.id }}">
                                Problem Details #{{ p.id }}
                            </h5>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>Erstellt: {{ p.created_at.strftime('%d.%m.%Y %H:%M') if p.created_at else 'Unbekannt' }}
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="problemTabs{{ p.id }}" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="details-tab{{ p.id }}" data-bs-toggle="tab" 
                                    data-bs-target="#details{{ p.id }}" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i>Details
                            </button>
                        </li>
                        <!-- Material Tab -->
                        {% if (p.status == 'in_bearbeitung' and p.massnahmen) or p.status == 'abgearbeitet' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="material-tab{{ p.id }}" data-bs-toggle="tab" 
                                    data-bs-target="#material{{ p.id }}" type="button" role="tab">
                                <i class="bi bi-box-seam me-1"></i>Material
                                {% if p.bestellung_benoetigt %}
                                <span class="badge bg-warning ms-1">!</span>
                                {% endif %}
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="problemTabContent{{ p.id }}">
                        <!-- Details Tab -->
                        <div class="tab-pane fade show active" id="details{{ p.id }}" role="tabpanel">
                            <div class="mb-4">
                        <!-- Problembeschreibung -->
                        <div class="mb-3">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-exclamation-triangle me-2"></i>Problembeschreibung
                            </h6>
                            <p class="mb-0">{{ p.problem }}</p>
                        </div>
                        
                        <!-- Kompakte Info-Zeile -->
                        <div class="d-flex align-items-center gap-4 bg-light rounded p-3 mb-3">
                            <!-- Status -->
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2">STATUS:</small>
                                {% if p.status == 'gemeldet' %}
                                    <span class="badge bg-danger">GEMELDET</span>
                                {% elif p.status == 'in_bearbeitung' %}
                                    <span class="badge bg-primary">IN BEARBEITUNG</span>
                                {% elif p.status == 'abgearbeitet' %}
                                    <span class="badge bg-success">ABGEARBEITET</span>
                                {% endif %}
                            </div>
                            
                            <!-- Bearbeiter -->
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2">BEARBEITER:</small>
                                {% if p.assigned_user %}
                                    <span class="fw-bold">{{ p.assigned_user.username }}</span>
                                {% elif p.verantwortlicher %}
                                    <span class="fw-bold">{{ p.verantwortlicher }}</span>
                                {% else %}
                                    <span class="text-muted">Nicht zugewiesen</span>
                                {% endif %}
                            </div>
                            
                            <!-- Anlage -->
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2">ANLAGE:</small>
                                <span class="fw-bold">{{ p.bohrturm }}</span>
                            </div>
                        </div>
                        
                        <!-- Maßnahmen - nur wenn vorhanden -->
                        {% if p.massnahmen %}
                        <div class="bg-primary bg-opacity-10 rounded p-3 mb-3">
                            <small class="text-primary fw-semibold d-block mb-1">GEPLANTE MASSNAHMEN</small>
                            <p class="mb-0">{{ p.massnahmen }}</p>
                        </div>
                        {% endif %}

                        <!-- Workflow-Buttons -->
                        {% if p.status == 'gemeldet' %}
                            {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                            <div class="text-center mt-4">
                                <a href="{{ url_for('edit_problem', problem_id=p.id) }}" 
                                   class="btn btn-primary btn-lg">
                                    <i class="bi bi-arrow-right me-2"></i>In Bearbeitung nehmen
                                </a>
                            </div>
                            {% endif %}
                        {% elif p.status == 'abgearbeitet' %}
                        <div class="text-center mt-4">
                            <a href="{{ url_for('delete_problem', problem_id=p.id) }}" 
                               class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>Abschließen
                            </a>
                        </div>
                        {% endif %}
                        </div> <!-- Ende Details Tab -->

                        <!-- Material Tab -->
                        {% if (p.status == 'in_bearbeitung' and p.massnahmen) or p.status == 'abgearbeitet' %}
                        <div class="tab-pane fade" id="material{{ p.id }}" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-12">
                                    <!-- Material hinzufügen Button -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="bi bi-box-seam me-2"></i>Material-Liste
                                        </h6>
                                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="collapse" data-bs-target="#addMaterial{{ p.id }}">
                                            <i class="bi bi-plus-circle me-1"></i>Material hinzufügen
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Material hinzufügen Form (collapsed) -->
                                    <div class="collapse mb-3" id="addMaterial{{ p.id }}">
                                        <div class="card border-light bg-light">
                                            <div class="card-body">
                                                <form method="post" action="{{ url_for('add_material', problem_id=p.id) }}">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label for="mm_nummer{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-upc-scan me-1"></i>MM-Nummer *
                                                            </label>
                                                            <input type="text" id="mm_nummer{{ p.id }}" name="mm_nummer" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. MM-234234" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="beschreibung{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-tag me-1"></i>Beschreibung *
                                                            </label>
                                                            <input type="text" id="beschreibung{{ p.id }}" name="beschreibung" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. Hydraulikzylinder" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="menge{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-123 me-1"></i>Menge
                                                            </label>
                                                            <input type="number" id="menge{{ p.id }}" name="menge" 
                                                                   class="form-control form-control-sm" 
                                                                   value="1" min="1">
                                                        </div>
                                                        <div class="col-md-3 d-flex align-items-end">
                                                            <button type="submit" class="btn btn-success btn-sm w-100">
                                                                <i class="bi bi-plus me-1"></i>Hinzufügen
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Material-Liste -->
                                    {% if p.materials %}
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col"><i class="bi bi-upc-scan me-1"></i>MM-Nummer</th>
                                                    <th scope="col"><i class="bi bi-tag me-1"></i>Beschreibung</th>
                                                    <th scope="col"><i class="bi bi-123 me-1"></i>Menge</th>
                                                    <!-- RSC Material-Order-Management Spalten -->
                                                    {% if is_rsc_for_problem(p) %}
                                                    <th scope="col"><i class="bi bi-receipt me-1"></i>PR-Nummer</th>
                                                    <th scope="col"><i class="bi bi-basket me-1"></i>PO-Nummer</th>
                                                    <th scope="col"><i class="bi bi-calendar me-1"></i>Lieferdatum</th>
                                                    <th scope="col"><i class="bi bi-check-circle me-1"></i>Bestätigt</th>
                                                    {% endif %}
                                                    <th scope="col">Aktionen</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for material in p.materials %}
                                                <tr>
                                                    <td><code>{{ material.mm_nummer }}</code></td>
                                                    <td>{{ material.beschreibung }}</td>
                                                    <td><span class="badge bg-secondary">{{ material.menge or 1 }}x</span></td>
                                                    
                                                    <!-- RSC Material-Order-Management Felder -->
                                                    {% if is_rsc_for_problem(p) %}
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   value="{{ material.pr_nummer or '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'pr_nummer', this.value)"
                                                                   placeholder="PR-Nummer">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-basket"></i></span>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   value="{{ material.po_nummer or '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'po_nummer', this.value)"
                                                                   placeholder="PO-Nummer">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                            <input type="date" class="form-control form-control-sm" 
                                                                   value="{{ material.lieferdatum.strftime('%Y-%m-%d') if material.lieferdatum else '' }}"
                                                                   onchange="updateMaterialField({{ material.id }}, 'lieferdatum', this.value)">
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        {% if material.bestellung_bestaetigt %}
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle me-1"></i>Bestätigt
                                                            </span>
                                                        {% else %}
                                                            <button class="btn btn-outline-success btn-sm" 
                                                                    onclick="confirmMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                                <i class="bi bi-check"></i>
                                                            </button>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                    
                                                    <td>
                                                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                                        <button class="btn btn-outline-danger btn-sm" 
                                                                onclick="deleteMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-box-seam fs-1 opacity-25"></i>
                                        <p class="mt-2">Noch kein Material hinzugefügt</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div> <!-- Ende Material Tab -->
                        {% endif %}
                    </div> <!-- Ende Tab Content -->
                    
                    <!-- Progress Updates - außerhalb der Tabs -->
                    {% if p.progress_update_list %}
                    <div class="mt-3 border-top pt-3">
                        <h6 class="fw-semibold mb-2">
                            <i class="bi bi-clock-history me-1 text-success"></i>Fortschritt-Updates:
                        </h6>
                        {% for update in p.progress_update_list %}
                        <div class="alert alert-success py-2 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <small class="d-block">{{ update.text }}</small>
                                </div>
                            </div>
                            <hr class="my-1">
                            <small class="text-muted">
                                <i class="bi bi-person me-1"></i>{{ update.user }} • 
                                <i class="bi bi-clock me-1"></i>{{ update.timestamp[:19] | replace('T', ' ') }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Maßnahme hinzufügen - nur bei in Bearbeitung und Berechtigung -->
                    {% if p.status == 'in_bearbeitung' and (is_admin or (user_facility and user_facility == p.bohrturm)) %}
                    <div class="mt-3 border-top pt-3">
                        <button type="button" class="btn btn-outline-success btn-sm w-100" 
                                data-bs-toggle="collapse" data-bs-target="#addUpdate{{ p.id }}" 
                                aria-expanded="false">
                            <i class="bi bi-plus-circle me-1"></i>Maßnahme hinzufügen
                        </button>
                        
                        <div class="collapse mt-2" id="addUpdate{{ p.id }}">
                            <form method="post" action="{{ url_for('add_progress_update', problem_id=p.id) }}">
                                <div class="card border-success">
                                    <div class="card-body p-3">
                                        <div class="mb-2">
                                            <label for="updateText{{ p.id }}" class="form-label fw-semibold small">
                                                <i class="bi bi-pencil me-1"></i>Fortschritt-Update:
                                            </label>
                                            <textarea id="updateText{{ p.id }}" name="update_text" 
                                                      class="form-control form-control-sm" rows="2" 
                                                      placeholder="z.B. Teil eingelagert - Warte auf Zugriff an Maschine" 
                                                      required></textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-check2 me-1"></i>Hinzufügen
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    data-bs-toggle="collapse" data-bs-target="#addUpdate{{ p.id }}">
                                                Abbrechen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Löschkommentar anzeigen -->
                    {% if p.loeschen_kommentar %}
                    <div class="mt-3 border-top pt-3">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">
                                <i class="bi bi-chat-text me-2"></i>Kommentar
                            </h6>
                            <p class="mb-0">{{ p.loeschen_kommentar }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="modal-footer border-top d-flex justify-content-between align-items-center">
            <!-- Workflow-Buttons -->
            <div class="d-flex gap-2">
                {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                    {% if p.status == 'offen' %}
                    <form method="post" action="{{ url_for('update_problem_status', problem_id=p.id) }}" class="d-inline">
                        <input type="hidden" name="status" value="in_bearbeitung">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-play-circle me-1"></i>Bearbeitung starten
                        </button>
                    </form>
                    {% elif p.status == 'in_bearbeitung' %}
                    <form method="post" action="{{ url_for('update_problem_status', problem_id=p.id) }}" class="d-inline">
                        <input type="hidden" name="status" value="abgearbeitet">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-circle me-1"></i>Abschließen
                        </button>
                    </form>
                    {% elif p.status == 'abgearbeitet' %}
                    <form method="post" action="{{ url_for('update_problem_status', problem_id=p.id) }}" class="d-inline">
                        <input type="hidden" name="status" value="archiviert">
                        <button type="submit" class="btn btn-secondary btn-sm">
                            <i class="bi bi-archive me-1"></i>Archivieren
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Schließen Button -->
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-1"></i>Schließen
            </button>
        </div>
    </div>
</div>
</div>
{% endfor %}
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            <i class="bi bi-box-seam me-2"></i>Material-Liste
                                        </h6>
                                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="collapse" data-bs-target="#addMaterial{{ p.id }}">
                                            <i class="bi bi-plus-circle me-1"></i>Material hinzufügen
                                        </button>
                                        {% else %}
                                        <span class="badge bg-light text-muted">
                                            <i class="bi bi-info-circle me-1"></i>Nur {{ p.bohrturm }}-Personal
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Material hinzufügen Form (collapsed) -->
                                    <div class="collapse mb-3" id="addMaterial{{ p.id }}">
                                        <div class="card border-light bg-light">
                                            <div class="card-body">
                                                <form method="post" action="{{ url_for('add_material', problem_id=p.id) }}">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label for="mm_nummer{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-upc-scan me-1"></i>MM-Nummer *
                                                            </label>
                                                            <input type="text" id="mm_nummer{{ p.id }}" name="mm_nummer" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. MM-234234" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="beschreibung{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-tag me-1"></i>Beschreibung *
                                                            </label>
                                                            <input type="text" id="beschreibung{{ p.id }}" name="beschreibung" 
                                                                   class="form-control form-control-sm" 
                                                                   placeholder="z.B. Hydraulikzylinder" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="menge{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-123 me-1"></i>Menge
                                                            </label>
                                                            <input type="number" id="menge{{ p.id }}" name="menge" 
                                                                   class="form-control form-control-sm" 
                                                                   value="1" min="1" max="999">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="mt-4 pt-2">
                                                                <small class="text-muted">
                                                                    <i class="bi bi-person-check me-1"></i>
                                                                    Besteller: <strong>{{ session.get('user') }}</strong>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row mt-2">
                                                        <div class="col-md-3">
                                                            <label for="einheit{{ p.id }}" class="form-label fw-semibold small">
                                                                <i class="bi bi-rulers me-1"></i>Einheit
                                                            </label>
                                                            <select id="einheit{{ p.id }}" name="einheit" class="form-select form-select-sm">
                                                                <option value="Stück">Stück</option>
                                                                <option value="Liter">Liter</option>
                                                                <option value="Meter">Meter</option>
                                                                <option value="kg">kg</option>
                                                                <option value="Set">Set</option>
                                                                <option value="Rolle">Rolle</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-9">
                                                            <div class="alert alert-info alert-sm py-2 mt-4 mb-0">
                                                                <i class="bi bi-info-circle me-1"></i>
                                                                <small><strong>RSC wird automatisch benachrichtigt</strong> wenn Material hinzugefügt wird</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2 mt-3">
                                                        <button type="submit" class="btn btn-success btn-sm">
                                                            <i class="bi bi-check2 me-1"></i>Material hinzufügen
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                                data-bs-toggle="collapse" data-bs-target="#addMaterial{{ p.id }}">
                                                            Abbrechen
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Material Tabelle -->
                                    <div class="card">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 12%;">
                                                            <i class="bi bi-upc-scan me-1"></i>MM-Nummer
                                                        </th>
                                                        <th style="width: 22%;">
                                                            <i class="bi bi-tag me-1"></i>Beschreibung
                                                        </th>
                                                        <th style="width: 12%;">
                                                            <i class="bi bi-person me-1"></i>Besteller
                                                        </th>
                                                        <th style="width: 15%;">
                                                            <i class="bi bi-file-text me-1"></i>PR-Nummer
                                                        </th>
                                                        <th style="width: 15%;">
                                                            <i class="bi bi-receipt me-1"></i>PO-Nummer
                                                        </th>
                                                        <th style="width: 14%;">
                                                            <i class="bi bi-calendar-event me-1"></i>Lieferdatum
                                                        </th>
                                                        <th style="width: 8%;">
                                                            <i class="bi bi-flag me-1"></i>Status
                                                        </th>
                                                        <th style="width: 2%;">Aktionen</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% if p.material_items %}
                                                        {% for material in p.material_items %}
                                                        <tr>
                                                            <td>
                                                                <span class="badge bg-primary">{{ material.mm_nummer }}</span>
                                                            </td>
                                                            <td>{{ material.beschreibung }}</td>
                                                            <td>
                                                                {% if material.besteller_user %}
                                                                    <span class="badge bg-info">{{ material.besteller_user.username }}</span>
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if is_rsc_for_problem(p) %}
                                                                    <div class="input-group input-group-sm">
                                                                        <span class="input-group-text bg-light">
                                                                            <i class="bi bi-file-text text-primary"></i>
                                                                        </span>
                                                                        <input type="text" class="form-control" 
                                                                               id="pr_{{ material.id }}" value="{{ material.pr_nummer or '' }}"
                                                                               placeholder="PR-Nummer eingeben..." 
                                                                               onchange="updateMaterialField({{ material.id }}, 'pr_nummer', this.value)"
                                                                               style="font-size: 0.875rem;">
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">{{ material.pr_nummer or '-' }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if is_rsc_for_problem(p) %}
                                                                    <div class="input-group input-group-sm">
                                                                        <span class="input-group-text bg-light">
                                                                            <i class="bi bi-receipt text-success"></i>
                                                                        </span>
                                                                        <input type="text" class="form-control" 
                                                                               id="po_{{ material.id }}" value="{{ material.po_nummer or '' }}"
                                                                               placeholder="PO-Nummer eingeben..."
                                                                               onchange="updateMaterialField({{ material.id }}, 'po_nummer', this.value)"
                                                                               style="font-size: 0.875rem;">
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">{{ material.po_nummer or '-' }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if is_rsc_for_problem(p) %}
                                                                    <div class="input-group input-group-sm">
                                                                        <span class="input-group-text bg-light">
                                                                            <i class="bi bi-calendar-event text-info"></i>
                                                                        </span>
                                                                        <input type="date" class="form-control" 
                                                                               id="lieferdatum_{{ material.id }}" 
                                                                               value="{{ material.lieferdatum.strftime('%Y-%m-%d') if material.lieferdatum else '' }}"
                                                                               onchange="updateMaterialField({{ material.id }}, 'lieferdatum', this.value)"
                                                                               style="font-size: 0.875rem;">
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted">
                                                                        {% if material.lieferdatum %}
                                                                            <i class="bi bi-calendar-check text-success me-1"></i>
                                                                            {{ material.lieferdatum.strftime('%d.%m.%Y') }}
                                                                        {% else %}
                                                                            <i class="bi bi-calendar-x text-muted me-1"></i>
                                                                            Nicht gesetzt
                                                                        {% endif %}
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if material.bestellt %}
                                                                    <span class="badge bg-success">
                                                                        <i class="bi bi-check-circle me-1"></i>Bestellt
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-warning">
                                                                        <i class="bi bi-clock me-1"></i>Ausstehend
                                                                    </span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                                                                <div class="btn-group">
                                                                    {% if not material.bestellt and session['user'] and material.besteller_user and session['user'] == material.besteller_user.username %}
                                                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                                                            onclick="confirmMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                                        <i class="bi bi-check"></i>
                                                                    </button>
                                                                    {% endif %}
                                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                            onclick="deleteMaterial({{ material.id }}, '{{ material.beschreibung }}')">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </div>
                                                                {% else %}
                                                                <span class="badge bg-light text-muted">
                                                                    <i class="bi bi-lock"></i> Gesperrt
                                                                </span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="8" class="text-center py-4 text-muted">
                                                                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                                                                Noch kein Material hinzugefügt.
                                                                <br><small>Verwenden Sie den Button "Material hinzufügen" um zu beginnen.</small>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Hinweis wenn Material-Tab nicht verfügbar -->
                        <div class="tab-pane fade" id="material{{ p.id }}" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Material-Management nicht verfügbar</strong><br>
                                Material kann nur nach der eigentlichen Problembearbeitung (Schritt 2) oder für Korrekturen bei abgearbeiteten Problemen hinzugefügt werden.
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Einfacher Bestätigen-Button -->
                    {% if p.status == 'gemeldet' %}
                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                        <div class="text-center">
                            <a href="{{ url_for('edit_problem', problem_id=p.id) }}" 
                               class="btn btn-primary px-4">
                                Bestätigen
                            </a>
                        </div>
                        {% else %}
                        <div class="border-top pt-4 mt-4">
                            <div class="alert alert-light text-center" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                Nur {{ p.bohrturm }}-Personal kann dieses Problem bearbeiten
                            </div>
                        </div>
                        {% endif %}
                    {% elif p.status == 'in_bearbeitung' and (p.massnahmen or is_admin) %}
                        {% if is_admin or (user_facility and user_facility == p.bohrturm) %}
                        <div class="border-top pt-4 mt-4">
                            <div class="alert alert-success text-center" role="alert">
                                <i class="bi bi-check-circle me-2"></i>
                                Problem wird bearbeitet - Material kann hinzugefügt werden
                            </div>
                        </div>
                        {% else %}
                        <div class="border-top pt-4 mt-4">
                            <div class="alert alert-light text-center" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                Nur {{ p.bohrturm }}-Personal kann dieses Problem bearbeiten
                            </div>
                        </div>
                        {% endif %}
                    {% elif p.status == 'abgearbeitet' %}
                    <div class="text-center">
                        <a href="{{ url_for('delete_problem', problem_id=p.id) }}" 
                           class="btn btn-success px-4">
                            Bestätigen
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-0 bg-light justify-content-center py-3">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left me-2"></i>Zurück
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Verstecktes Form für direktes Löschen -->
    {% if is_admin %}
    <form id="deleteForm" method="post" style="display: none;">
        <input type="hidden" name="direct_delete" value="1">
        <input type="hidden" name="problem_id" id="deleteProblemId">
    </form>
    {% endif %}

    <script>
        {% if is_admin %}
        function confirmDelete(problemId, problemText) {
            if (confirm('⚠️ ACHTUNG: Problem direkt löschen?\n\n"' + problemText + '"\n\nDiese Aktion kann nicht rückgängig gemacht werden!')) {
                document.getElementById('deleteProblemId').value = problemId;
                document.getElementById('deleteForm').action = '/admin/delete_problem/' + problemId;
                document.getElementById('deleteForm').submit();
            }
        }
        {% endif %}

        // Auto-Refresh der Probleme-Tabelle - Standard: 30 Sekunden
        let refreshInterval;
        let refreshIntervalTime = 60000; // 60 Sekunden (1 Minute)

        function refreshProblemsTable() {
            fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Erstelle einen temporären DOM-Parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extrahiere die neue Tabelle
                const newTableContainer = doc.querySelector('.table-responsive');
                const currentTableContainer = document.querySelector('.table-responsive');
                
                if (newTableContainer && currentTableContainer) {
                    currentTableContainer.innerHTML = newTableContainer.innerHTML;
                    
                    // Update der Modals
                    const newModals = doc.querySelectorAll('.modal');
                    const currentModals = document.querySelectorAll('.modal');
                    
                    // Entferne alte Modals
                    currentModals.forEach(modal => {
                        if (modal.id.startsWith('detailModal') || modal.id.startsWith('imageModal')) {
                            modal.remove();
                        }
                    });
                    
                    // Füge neue Modals hinzu
                    newModals.forEach(modal => {
                        if (modal.id.startsWith('detailModal') || modal.id.startsWith('imageModal')) {
                            document.body.appendChild(modal);
                        }
                    });
                    
                }
            })
            .catch(error => {
                console.error('Fehler beim Aktualisieren der Tabelle:', error);
            });
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(refreshProblemsTable, refreshIntervalTime);
        }


        // Material-Management Funktionen
        function updateMaterialField(materialId, fieldName, value) {
            let inputId;
            if (fieldName === 'pr_nummer') {
                inputId = `pr_${materialId}`;
            } else if (fieldName === 'po_nummer') {
                inputId = `po_${materialId}`;
            } else if (fieldName === 'lieferdatum') {
                inputId = `lieferdatum_${materialId}`;
            }
            
            const inputElement = document.getElementById(inputId);
            if (!inputElement) {
                console.error(`Element mit ID ${inputId} nicht gefunden!`);
                alert(`Eingabefeld nicht gefunden: ${inputId}`);
                return;
            }
            
            const originalBorder = inputElement.style.border;
            
            // Visuelles Feedback: Loading-Zustand
            inputElement.style.border = '2px solid #007bff';
            inputElement.disabled = true;
            
            fetch(`/update_material_field/${materialId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    field: fieldName,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Erfolgreich: Grüner Rahmen für 2 Sekunden
                    inputElement.style.border = '2px solid #28a745';
                    setTimeout(() => {
                        inputElement.style.border = originalBorder;
                    }, 2000);
                } else {
                    // Fehler: Roter Rahmen und Alert
                    inputElement.style.border = '2px solid #dc3545';
                    alert(`Fehler beim Aktualisieren: ${data.error}`);
                    // Bei Fehler das Feld zurücksetzen
                    inputElement.value = '';
                    setTimeout(() => {
                        inputElement.style.border = originalBorder;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                inputElement.style.border = '2px solid #dc3545';
                alert('Fehler beim Aktualisieren der Daten');
                setTimeout(() => {
                    inputElement.style.border = originalBorder;
                }, 3000);
            })
            .finally(() => {
                inputElement.disabled = false;
            });
        }

        function confirmMaterial(materialId, materialName) {
            if (confirm(`Material-Bestellung "${materialName}" bestätigen?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/confirm_material/${materialId}`;
                
                // PR-Nummer optional abfragen
                const prNummer = prompt('PR-Nummer (optional):');
                if (prNummer !== null) {
                    const prInput = document.createElement('input');
                    prInput.type = 'hidden';
                    prInput.name = 'pr_nummer';
                    prInput.value = prNummer || '';
                    form.appendChild(prInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        function deleteMaterial(materialId, materialName) {
            if (confirm(`Material "${materialName}" wirklich löschen?`)) {
                fetch(`/delete_material/${materialId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Entferne die Material-Zeile visuell (finde über den Button)
                        const button = document.querySelector(`button[onclick*="deleteMaterial(${materialId}"]`);
                        if (button) {
                            const row = button.closest('tr');
                            if (row) {
                                row.style.opacity = '0.5';
                                row.style.textDecoration = 'line-through';
                                // Zeige kurze Bestätigung
                                const cell = row.querySelector('td');
                                if (cell) {
                                    const originalText = cell.innerHTML;
                                    cell.innerHTML = '<span class="text-success"><i class="bi bi-check"></i> Gelöscht</span>';
                                    setTimeout(() => {
                                        if (row.parentNode) {
                                            row.remove();
                                        }
                                    }, 2000);
                                }
                            }
                        }
                    } else {
                        alert('Fehler beim Löschen: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    alert('Fehler beim Löschen des Materials.');
                });
            }
        }

        // Modal automatisch öffnen wenn URL-Fragment vorhanden ist
        function openModalFromHash() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#detailModal')) {
                // Überprüfe ob Material-Tab aktiviert werden soll
                const shouldActivateMaterial = hash.includes('-material');
                const modalId = hash.split('-')[0]; // z.B. #detailModal13
                const modalElement = document.querySelector(modalId);
                
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    
                    // Aktiviere Material-Tab wenn gewünscht
                    if (shouldActivateMaterial) {
                        const materialTabButton = modalElement.querySelector('button[data-bs-target*="material"]');
                        if (materialTabButton) {
                            materialTabButton.click();
                        }
                    }
                    
                    // Hash aus URL entfernen nach dem Öffnen
                    history.replaceState(null, null, ' ');
                }
            }
        }



        // Auto-Refresh starten
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
            openModalFromHash();
        });
    </script>
{% endblock %}
